<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corwin's FIRE Calc</title>
  
  <meta name="description" content="A Financial Independence, Retire Early (FIRE) calculator. Plan your retirement with Monte Carlo simulations, government pension integration, and custom portfolio allocations.">
  <meta name="keywords" content="FIRE calculator, retirement, Monte Carlo simulation, early retirement, financial independence, CPP, OAS, Social Security, TFSA, Roth IRA, RRSP, 401k">
  <meta name="author" content="Corwin">
  <link rel="canonical" href="https://cor.win/firecalc.html">

  <meta property="og:title" content="Corwin's FIRE Calc">
  <meta property="og:description" content="Plan your early retirement with this advanced Monte Carlo simulation tool. Account for tax-advantaged accounts and inflation.">
  <meta property="og:url" content="https://cor.win/firecalc.html">
  <meta property="og:type" content="website">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Corwin's FIRE Calc">
  <meta name="twitter:description" content="Plan your early retirement with this advanced Monte Carlo simulation tool.">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
      tailwind.config = {
          darkMode: 'class',
          theme: {
              extend: {
                  fontFamily: {
                      sans: ['Inter', 'sans-serif'],
                      mono: ['JetBrains Mono', 'monospace'],
                  },
                  colors: {
                      border: "hsl(var(--border))",
                      input: "hsl(var(--input))",
                      ring: "hsl(var(--ring))",
                      background: "hsl(var(--background))",
                      foreground: "hsl(var(--foreground))",
                      primary: {
                          DEFAULT: "hsl(var(--primary))",
                          foreground: "hsl(var(--primary-foreground))",
                      },
                      secondary: {
                          DEFAULT: "hsl(var(--secondary))",
                          foreground: "hsl(var(--secondary-foreground))",
                      },
                      muted: {
                          DEFAULT: "hsl(var(--muted))",
                          foreground: "hsl(var(--muted-foreground))",
                      },
                      card: {
                          DEFAULT: "hsl(var(--card))",
                          foreground: "hsl(var(--card-foreground))",
                      },
                  }
              }
          }
      }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: hsl(var(--border));
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: hsl(var(--muted-foreground));
    }
  </style>
</head>
<body class="bg-[hsl(var(--background))]">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    let baseSeed = 1;

    const THEMES = {
      zinc: `--background: 240 10% 4%; --foreground: 0 0% 98%; --card: 240 10% 9%; --card-foreground: 0 0% 98%; --primary: 75 100% 50%; --primary-foreground: 240 10% 4%; --muted: 240 4% 16%; --muted-foreground: 240 5% 65%; --border: 240 4% 16%; --ring: 75 100% 50%; --chart-grid: rgba(255,255,255,0.05); --chart-text: #94a3b8; --card-gradient: linear-gradient(135deg, hsl(240 10% 4%) 0%, hsl(75 100% 10%) 100%); --primary-gradient: linear-gradient(135deg, hsl(75 100% 50%) 0%, hsl(75 100% 35%) 100%);`,
      sage: `--background: 155 10% 6%; --foreground: 155 10% 98%; --card: 155 10% 10%; --card-foreground: 155 10% 98%; --primary: 150 100% 45%; --primary-foreground: 155 20% 10%; --muted: 155 10% 18%; --muted-foreground: 155 10% 65%; --border: 155 10% 18%; --ring: 150 100% 45%; --chart-grid: rgba(255,255,255,0.05); --chart-text: #94a3b8; --card-gradient: linear-gradient(135deg, hsl(155 10% 6%) 0%, hsl(150 100% 10%) 100%); --primary-gradient: linear-gradient(135deg, hsl(150 100% 45%) 0%, hsl(150 100% 30%) 100%);`,
      light: `--background: 210 40% 98%; --foreground: 240 10% 4%; --card: 0 0% 100%; --card-foreground: 240 10% 4%; --primary: 84 81% 44%; --primary-foreground: 0 0% 100%; --muted: 240 5% 90%; --muted-foreground: 240 4% 46%; --border: 240 6% 85%; --ring: 84 81% 44%; --chart-grid: rgba(0,0,0,0.05); --chart-text: #64748b; --card-gradient: linear-gradient(135deg, hsl(0 0% 100%) 0%, hsl(84 81% 90%) 100%); --primary-gradient: linear-gradient(135deg, hsl(84 81% 44%) 0%, hsl(84 81% 30%) 100%);`
    };

    const LABELS = {
      CA: { title: "Corwin's FIRE Calc (Canada)", currency: "CAD", locale: "en-CA", symbol: "$", tfsa: "TFSA ($)", tfsaTooltip: "Tax-Free Savings Account", rrsp: "RRSP / LIRA ($)", rrspTooltip: "Tax-deferred retirement plan", nonreg: "Non-Registered ($)", nonregTooltip: "Taxable investments", govPension: "CPP/OAS ($)", govPensionTooltip: "Government benefits in today's dollars", tableNominal: "ALL VALUES NOMINAL CAD" },
      US: { title: "Corwin's FIRE Calc (USA)", currency: "USD", locale: "en-US", symbol: "$", tfsa: "Roth IRA ($)", tfsaTooltip: "Tax-Free individual retirement account", rrsp: "401(k) / Trad IRA ($)", rrspTooltip: "Tax-deferred retirement plan", nonreg: "Taxable Brokerage ($)", nonregTooltip: "Standard taxable investment account", govPension: "Social Security ($)", govPensionTooltip: "Social Security benefits (in today's dollars)", tableNominal: "ALL VALUES NOMINAL USD" },
      EU: { title: "Corwin's FIRE Calc (EU)", currency: "EUR", locale: "en-IE", symbol: "â‚¬", tfsa: "Tax-Free Savings (â‚¬)", tfsaTooltip: "Tax-advantaged savings like ISA or equivalent", rrsp: "Pension Account (â‚¬)", rrspTooltip: "Tax-deferred retirement or pension plan", nonreg: "Investment Account (â‚¬)", nonregTooltip: "Standard taxable brokerage account", govPension: "State Pension (â‚¬)", govPensionTooltip: "National state pension benefits (in today's euros)", tableNominal: "ALL VALUES NOMINAL EUR" }
    };

    const KEY_MAP = {
      country: 'c', age: 'a', years: 'y', simulations: 's', tfsa: 't', rrsp: 'r', nonreg: 'n',
      cash: 'ch', stockAlloc: 'sa', withdrawalAmount: 'wa', withdrawalRate: 'wr', inflation: 'i',
      flexibleSpending: 'fs', marketReturn: 'mr', marketVariance: 'mv', bondReturn: 'br',
      merFee: 'mf', currentIncome: 'ci', currentIncomeEnd: 'cie', otherIncome: 'oi',
      otherIncomeStart: 'ois'
    };

    const REVERSE_KEY_MAP = Object.fromEntries(Object.entries(KEY_MAP).map(([k, v]) => [v, k]));

    const formatCurrency = (num, currencyCode = 'CAD', localeCode = 'en-CA') => {
      if (isNaN(num)) return '$0';
      return new Intl.NumberFormat(localeCode, { style: 'currency', currency: currencyCode, maximumFractionDigits: 0 }).format(num);
    };

    const parseCurrency = (val) => {
      const clean = String(val).replace(/[^0-9.]/g, '');
      return parseFloat(clean) || 0;
    };

    const getMedian = (values) => {
      if (!values || values.length === 0) return 0;
      const sorted = [...values].sort((a, b) => a - b);
      const half = Math.floor(sorted.length / 2);
      if (sorted.length % 2) return sorted[half];
      return (sorted[half - 1] + sorted[half]) / 2.0;
    };

    const Leaf = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 20A7 7 0 0 1 14 6a7 7 0 0 1 7 7v7h-7a7 7 0 0 1-3-10z"></path></svg>;
    const User = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
    const Coins = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="8" cy="8" r="6"></circle><path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path><path d="M7 6h1v4"></path><path d="m16.71 13.88.7.71-2.82 2.82"></path></svg>;
    const Sliders = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="21" y2="14"></line><line x1="4" x2="20" y1="10" y2="3"></line><line x1="12" x2="12" y1="21" y2="14"></line><line x1="12" x2="12" y1="10" y2="3"></line><path d="M8 14h8v-4H8v4z"></path></svg>;
    const Banknote = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="12" x="2" y="6" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path></svg>;
    const Dices = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="12" height="12" x="2" y="10" rx="2" ry="2"></rect><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"></path><path d="M6 18h.01"></path><path d="M10 14h.01"></path><path d="M15 6h.01"></path><path d="M18 9h.01"></path></svg>;
    const Info = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>;
    const ChevronDown = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"></path></svg>;
    const Share2 = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>;
    const ShieldCheck = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>;
    const Link2 = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 17H7A5 5 0 0 1 7 7h2"></path><path d="M15 7h2a5 5 0 0 1 0 10h-2"></path><line x1="8" x2="16" y1="12" y2="12"></line></svg>;

    const Tooltip = ({ text }) => (
      <div className="group relative ml-1 inline-flex items-center">
        <Info className="h-3 w-3 text-[hsl(var(--primary))/70] cursor-help transition-colors hover:text-[hsl(var(--primary))]" />
        <div className="pointer-events-none absolute bottom-full right-0 z-50 mb-2 w-56 opacity-0 shadow-xl transition-all group-hover:opacity-100 bg-[hsl(var(--card))] border border-[hsl(var(--primary))/30] text-[hsl(var(--foreground))] text-xs rounded-lg p-3 normal-case font-medium text-left backdrop-blur-sm">
          {text}
        </div>
      </div>
    );

    const CurrencyInput = ({ label, value, onChange, max, tooltip, icon: Icon, currency, locale }) => {
      const [localVal, setLocalVal] = useState(formatCurrency(value, currency, locale));
      const [isFocused, setIsFocused] = useState(false);
      useEffect(() => { if (!isFocused) setLocalVal(formatCurrency(value, currency, locale)); }, [value, isFocused, currency, locale]);
      const handleFocus = () => { setIsFocused(true); setLocalVal(value === 0 ? '' : Math.round(value).toString()); };
      const handleChange = (e) => {
        setLocalVal(e.target.value);
        let num = parseCurrency(e.target.value);
        if (!isNaN(num)) { if (max !== undefined && num > max) num = max; onChange(Math.round(num)); }
      };
      const handleBlur = () => {
        setIsFocused(false);
        let num = Math.round(parseCurrency(localVal));
        if (max !== undefined && num > max) num = max;
        onChange(num);
        setLocalVal(formatCurrency(num, currency, locale));
      };
      return (
        <div className="space-y-1.5 w-full">
          <div className="flex items-center justify-between">
            <label className="text-xs font-semibold text-[hsl(var(--muted-foreground))] flex items-center gap-1">{Icon && <Icon className="h-3 w-3" />}{label}</label>
            {tooltip && <Tooltip text={tooltip} />}
          </div>
          <input type="text" value={localVal} onChange={handleChange} onFocus={handleFocus} onBlur={handleBlur} onKeyDown={(e) => e.key === 'Enter' && e.target.blur()} className="flex h-10 w-full rounded-xl border border-[hsl(var(--border))] bg-transparent px-3 py-1 text-sm text-[hsl(var(--foreground))] shadow-sm transition-all hover:border-[hsl(var(--primary))/50] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[hsl(var(--primary))/50] focus-visible:border-[hsl(var(--primary))]" />
        </div>
      );
    };

    const FormInput = ({ label, value, onChange, tooltip, type = "text", min, max, step, icon: Icon, lazy = false }) => {
      const [localVal, setLocalVal] = useState(value);
      const [isFocused, setIsFocused] = useState(false);
      useEffect(() => { if (!isFocused) setLocalVal(value); }, [value, isFocused]);
      const handleChange = (e) => {
        setLocalVal(e.target.value);
        if (!lazy) { let num = parseFloat(e.target.value); if (!isNaN(num)) onChange(num); }
      };
      const handleBlur = () => {
        setIsFocused(false);
        let num = parseFloat(localVal);
        if (isNaN(num)) num = 0;
        if (min !== undefined && num < min) num = min;
        if (max !== undefined && num > max) num = max;
        setLocalVal(num);
        onChange(num);
      };
      return (
        <div className="space-y-1.5 w-full">
          <div className="flex items-center justify-between">
            <label className="text-xs font-semibold text-[hsl(var(--muted-foreground))] flex items-center gap-1">{Icon && <Icon className="h-3 w-3" />}{label}</label>
            {tooltip && <Tooltip text={tooltip} />}
          </div>
          <input type={type} value={localVal} onChange={handleChange} onFocus={() => setIsFocused(true)} onBlur={handleBlur} onKeyDown={(e) => e.key === 'Enter' && e.target.blur()} min={min} max={max} step={step} className="flex h-10 w-full rounded-xl border border-[hsl(var(--border))] bg-transparent px-3 py-1 text-sm text-[hsl(var(--foreground))] shadow-sm transition-all hover:border-[hsl(var(--primary))/50] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[hsl(var(--primary))/50] focus-visible:border-[hsl(var(--primary))]" />
        </div>
      );
    };

    const CollapsibleCard = ({ title, icon: Icon, children, defaultOpen = true, className = '' }) => {
      const [isOpen, setIsOpen] = useState(defaultOpen);
      return (
        <div className={`rounded-2xl border border-[hsl(var(--border))] bg-[hsl(var(--card))] shadow-md transition-colors duration-300 overflow-hidden ${className}`}>
          <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-5 hover:bg-[hsl(var(--muted))/50] transition-colors focus:outline-none">
            <div className="flex items-center gap-2 text-sm font-semibold text-[hsl(var(--foreground))]">{Icon && <Icon className="h-4 w-4 text-[hsl(var(--primary))]" />}{title}</div>
            <ChevronDown className={`h-4 w-4 text-[hsl(var(--primary))] transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} />
          </button>
          <div className={`grid transition-all duration-500 ease-in-out ${isOpen ? 'grid-rows-[1fr] opacity-100' : 'grid-rows-[0fr] opacity-0'}`}>
            <div className="overflow-hidden">
              <div className="p-5 pt-0">{children}</div>
            </div>
          </div>
        </div>
      );
    };

    const StatCard = ({ title, value, subtitle, highlight = false, isGradient = false }) => (
      <div className={`rounded-2xl border border-[hsl(var(--border))] p-5 shadow-md flex flex-col justify-center transition-colors duration-300 ${isGradient ? 'bg-[image:var(--card-gradient)]' : 'bg-[hsl(var(--card))]'}`}>
        <div className="mb-1 text-xs font-semibold uppercase tracking-wider text-[hsl(var(--muted-foreground))]">{title}</div>
        <div className={`text-2xl font-bold tracking-tight ${highlight && !isGradient ? 'text-[hsl(var(--primary))]' : 'text-[hsl(var(--foreground))]'}`}>{value}</div>
        {subtitle && <div className="mt-1 text-xs text-[hsl(var(--muted-foreground))] font-medium">{subtitle}</div>}
      </div>
    );

    const Slider = ({ value, min, max, onChange, label, displayValue }) => (
      <div className="space-y-2 w-full">
        {label && <div className="flex justify-between text-xs font-semibold text-[hsl(var(--muted-foreground))]"><span>{label}</span><span className="font-mono text-[hsl(var(--foreground))]">{displayValue || value}</span></div>}
        <input type="range" min={min} max={max} value={value} onChange={(e) => onChange(parseInt(e.target.value))} className="w-full h-1.5 appearance-none rounded-full bg-[hsl(var(--border))] [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-[hsl(var(--foreground))] [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-[hsl(var(--primary))] transition-all" />
      </div>
    );

    function App() {
      const currentYear = new Date().getFullYear();
      const defaultParams = { country: 'US', age: 50, years: 44, simulations: 200, tfsa: 100000, rrsp: 250000, nonreg: 50000, cash: 20000, stockAlloc: 60, withdrawalAmount: 16800, withdrawalRate: 4.0, inflation: 2.7, flexibleSpending: false, marketReturn: 8.0, marketVariance: 12.0, bondReturn: 2.5, merFee: 0.25, currentIncome: 0, currentIncomeEnd: currentYear + 5, otherIncome: 18000, otherIncomeStart: 2048 };

      const [theme, setTheme] = useState('zinc');
      const [isClient, setIsClient] = useState(false);
      const [shareText, setShareText] = useState('Share Link');
      const [params, setParams] = useState(defaultParams);
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      const [results, setResults] = useState({ successRate: 0, medianEnd: 0, p10End: 0, p90End: 0, target100: 0, medianPathData: [], simulationDatasets: [], yearlyAggregates: [], earliestFailureIndex: -1 });

      const encodeState = (state) => {
        const shortObj = {};
        for (const [fullK, val] of Object.entries(state)) { const shortK = KEY_MAP[fullK]; if (shortK) shortObj[shortK] = val; }
        return LZString.compressToEncodedURIComponent(JSON.stringify(shortObj));
      };

      const decodeState = (encoded) => {
        try {
          const decompressed = LZString.decompressFromEncodedURIComponent(encoded);
          if (!decompressed) return null;
          const shortObj = JSON.parse(decompressed);
          const fullObj = {};
          for (const [shortK, val] of Object.entries(shortObj)) { const fullK = REVERSE_KEY_MAP[shortK]; if (fullK) fullObj[fullK] = val; }
          return fullObj;
        } catch (e) { return null; }
      };

      useEffect(() => {
        setIsClient(true);
        const urlParams = new URLSearchParams(window.location.search);
        let finalParams = { ...defaultParams };
        let stateLoaded = false;
        const compressed = urlParams.get('d');
        if (compressed) {
          const decoded = decodeState(compressed);
          if (decoded) { finalParams = { ...finalParams, ...decoded }; stateLoaded = true; }
        }
        if (!stateLoaded) {
          for (const [key, val] of urlParams.entries()) { if (key in defaultParams) { finalParams[key] = key === 'country' ? val : parseFloat(val); stateLoaded = true; } }
        }
        if (!stateLoaded) {
          const stored = localStorage.getItem('fireCalcData');
          if (stored) { try { const parsed = JSON.parse(stored); finalParams = { ...finalParams, ...parsed.params }; if (parsed.theme) setTheme(parsed.theme === 'slate' ? 'sage' : parsed.theme); } catch (e) {} }
        }
        setParams(finalParams);
      }, []);

      useEffect(() => { if (isClient) localStorage.setItem('fireCalcData', JSON.stringify({ params, theme })); }, [params, theme, isClient]);

      useEffect(() => {
        if (!isClient) return;
        const styleTag = document.getElementById('dynamic-theme') || document.createElement('style');
        styleTag.id = 'dynamic-theme'; document.head.appendChild(styleTag);
        styleTag.innerHTML = `:root { ${THEMES[theme] || THEMES['zinc']} }`;
        document.documentElement.setAttribute('data-theme', theme);
      }, [theme, isClient]);

      const curLabel = LABELS[params.country || 'CA'];
      const totalNow = params.tfsa + params.rrsp + params.nonreg + params.cash;

      const handleNumChange = (field, val, min, max) => {
        let num = parseFloat(val) || 0;
        if (min !== undefined && num < min) num = min;
        if (max !== undefined && num > max) num = max;
        setParams(p => ({ ...p, [field]: num }));
      };

      const handleCurrencyChange = (field, num) => {
        setParams(p => {
          const newParams = { ...p, [field]: Math.round(num) };
          const total = newParams.tfsa + newParams.rrsp + newParams.nonreg + newParams.cash;
          if (field === 'withdrawalAmount' && total > 0) newParams.withdrawalRate = parseFloat(((num / total) * 100).toFixed(4));
          else if (['tfsa', 'rrsp', 'nonreg', 'cash'].includes(field) && total > 0) newParams.withdrawalRate = parseFloat(((newParams.withdrawalAmount / total) * 100).toFixed(4));
          return newParams;
        });
      };

      const handleRateChange = (num) => {
        let cleanRate = parseFloat(num.toFixed(4));
        setParams(p => {
          const newParams = { ...p, withdrawalRate: cleanRate };
          const total = newParams.tfsa + newParams.rrsp + newParams.nonreg + newParams.cash;
          newParams.withdrawalAmount = Math.round(total * (cleanRate / 100));
          return newParams;
        });
      };

      const handleShare = () => {
        const encoded = encodeState(params);
        let shareUrl = 'https://cor.win/firecalc.html?d=' + encoded;
        
        try {
          if (window.location.origin !== 'null' && !window.location.protocol.startsWith('blob')) {
            const url = new URL(window.location.href);
            url.searchParams.set('d', encoded);
            shareUrl = url.toString();
            window.history.replaceState({}, '', url);
          }
        } catch (e) {}

        const dummy = document.createElement('input');
        document.body.appendChild(dummy);
        dummy.value = shareUrl;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        
        setShareText('Copied!');
        setTimeout(() => setShareText('Share Link'), 2000);
      };

      const handleReset = () => {
        localStorage.removeItem('fireCalcData');
        setParams(defaultParams);
        try {
          if (window.location.origin !== 'null' && !window.location.protocol.startsWith('blob')) {
            const url = new URL(window.location.href);
            url.search = '';
            window.history.replaceState({}, '', url);
          }
        } catch (e) {}
      };

      const handleReRoll = () => { baseSeed = Math.floor(Math.random() * 100000); runSimulation(); };

      const runSimulation = () => {
        const { age, years, tfsa, rrsp, nonreg, cash, stockAlloc, withdrawalAmount, inflation, flexibleSpending, marketReturn, marketVariance, bondReturn, merFee, currentIncome, currentIncomeEnd, otherIncome, otherIncomeStart } = params;
        const total = tfsa + rrsp + nonreg + cash;
        const infl = inflation / 100, mMean = marketReturn / 100, mVar = marketVariance / 100, bRet = bondReturn / 100, fee = merFee / 100, sPct = stockAlloc / 100;
        const wStock = total > 0 ? (tfsa + rrsp + nonreg) * sPct / total : 0;
        const wBond = total > 0 ? ((tfsa + rrsp + nonreg) * (1 - sPct) + cash) / total : 0;
        let blendedMean = (wStock * mMean) + (wBond * bRet) - fee;
        const blendedStdDev = wStock * mVar;
        const numSimulations = params.simulations;

        let seedGen = baseSeed;
        const marketReturnsMatrix = Array.from({ length: numSimulations }, () => Array.from({ length: years }, () => {
          let u = 0, v = 0; while (u === 0) { let x = Math.sin(seedGen++) * 10000; u = x - Math.floor(x); } while (v === 0) { let y = Math.sin(seedGen++) * 10000; v = y - Math.floor(y); }
          return blendedMean + (blendedStdDev * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v));
        }));

        let successes = 0, finalBalances = [], earliestFailureIndex = -1, minFailureStep = Infinity;
        const simulationDatasets = [];
        let yearlyAggregates = Array.from({ length: years + 1 }, () => ({ balances: [], withdrawals: [], incomes: [], growths: [] }));

        for (let s = 0; s < numSimulations; s++) {
          yearlyAggregates[0].balances.push(totalNow);
          let simBal = totalNow, simWithdrawal = withdrawalAmount, dataPoints = [simBal], runFailedStep = Infinity;
          for (let i = 1; i <= years; i++) {
            const year = currentYear + i;
            let simIncome = 0;
            if (year >= otherIncomeStart) simIncome += otherIncome * Math.pow(1 + infl, i);
            if (year <= currentIncomeEnd) simIncome += currentIncome * Math.pow(1 + infl, i);
            let investable = Math.max(0, simBal + simIncome - simWithdrawal);
            let growth = investable * marketReturnsMatrix[s][i - 1];
            let end = investable + growth;
            if (end <= 0) { end = 0; if (runFailedStep === Infinity) runFailedStep = i; }
            yearlyAggregates[i].balances.push(end);
            yearlyAggregates[i].withdrawals.push(simWithdrawal);
            yearlyAggregates[i].incomes.push(simIncome);
            yearlyAggregates[i].growths.push(growth);
            if (!(flexibleSpending && marketReturnsMatrix[s][i - 1] < 0)) simWithdrawal *= (1 + infl);
            simBal = end;
            if (dataPoints[dataPoints.length - 1] > 0) dataPoints.push(simBal);
          }
          if (runFailedStep === Infinity) successes++;
          finalBalances.push(simBal);
          if (runFailedStep < minFailureStep) { minFailureStep = runFailedStep; earliestFailureIndex = s; }
          simulationDatasets.push({ label: `Sim ${s}`, data: dataPoints, pointRadius: 0, fill: false, tension: 0.4 });
        }

        const sortedBalances = [...finalBalances].sort((a, b) => a - b);
        const medianPathData = yearlyAggregates.map(y => getMedian(y.balances));
        
        let target100 = total, low = 0, high = 50000000;
        for (let step = 0; step < 30; step++) {
          let mid = (low + high) / 2, allSuccess = true;
          for (let s = 0; s < numSimulations; s++) {
            let simBal = mid, simWithdrawal = withdrawalAmount, runFailed = false;
            for (let i = 1; i <= years; i++) {
              let simIncome = 0;
              if (currentYear + i >= otherIncomeStart) simIncome += otherIncome * Math.pow(1 + infl, i);
              if (currentYear + i <= currentIncomeEnd) simIncome += currentIncome * Math.pow(1 + infl, i);
              let end = Math.max(0, simBal + simIncome - simWithdrawal) * (1 + marketReturnsMatrix[s][i - 1]);
              if (end <= 0) { runFailed = true; break; }
              if (!(flexibleSpending && marketReturnsMatrix[s][i - 1] < 0)) simWithdrawal *= (1 + infl);
              simBal = end;
            }
            if (runFailed) { allSuccess = false; break; }
          }
          if (allSuccess) { target100 = mid; high = mid; } else { low = mid; }
        }

        const exactSuccess = (successes / numSimulations) * 100;
        setResults({ 
          successRate: (exactSuccess > 99 && exactSuccess < 100) ? parseFloat(exactSuccess.toFixed(1)) : Math.round(exactSuccess), 
          medianEnd: getMedian(finalBalances), p10End: sortedBalances[Math.floor(numSimulations * 0.1)], p90End: sortedBalances[Math.floor(numSimulations * 0.9)], 
          target100, medianPathData, simulationDatasets, yearlyAggregates, earliestFailureIndex 
        });
      };

      const getAdvice = () => {
        const { successRate } = results;
        const { stockAlloc, merFee, flexibleSpending, cash } = params;
        const advice = [];
        if (successRate >= 95) advice.push({ type: 'success', text: "Strategy robust. Current plan shows a high probability of success." });
        else if (successRate < 70) advice.push({ type: 'danger', text: "Probability of failure is high. Consider reducing spend or increasing equity exposure." });
        if (merFee > 0.5) advice.push({ type: 'warning', text: "Portfolio drag detected due to elevated management fees. Utilizing lower-fee investment options can significantly extend portfolio longevity." });
        if (stockAlloc < 50 && successRate < 90) advice.push({ type: 'warning', text: "Conservative asset mix may be creating equity drag preventing long-term sustainability." });
        if (cash > totalNow * 0.15) advice.push({ type: 'warning', text: "High cash position detected. Inflation may erode purchasing power faster than it can grow." });
        if (!flexibleSpending && successRate < 95) advice.push({ type: 'info', text: "Enable Flex Spend to skip inflation raises in down years, significantly improving success rates." });
        return advice;
      };

      useEffect(() => { if (isClient) runSimulation(); }, [params, isClient]);

      useEffect(() => {
        if (!isClient || !chartRef.current || results.simulationDatasets.length === 0) return;
        if (chartInstance.current) chartInstance.current.destroy();
        const style = getComputedStyle(document.documentElement);
        const getV = (n, f) => style.getPropertyValue(n).trim() || f;
        const getColor = (v) => (v && !v.startsWith('#') && !v.startsWith('hsl') && !v.startsWith('rgba')) ? `hsl(${v})` : v;
        const primaryColor = getColor(getV('--primary', '75 100% 50%')), bgCard = getColor(getV('--card', '240 10% 9%')), borderCard = getColor(getV('--border', '240 4% 16%')), foregroundColor = getColor(getV('--foreground', '#fff')), mutedForegroundColor = getColor(getV('--muted-foreground', '#a1a1aa'));
        const isL = theme === 'light', defC = isL ? 'rgba(37, 99, 235, 0.08)' : 'rgba(255, 255, 255, 0.05)', failC = 'rgba(244, 63, 94, 0.8)';
        const styledDS = results.simulationDatasets.map((ds, idx) => ({ ...ds, borderColor: idx === results.earliestFailureIndex ? failC : defC, borderWidth: idx === results.earliestFailureIndex ? 2 : 1, order: idx === results.earliestFailureIndex ? 2 : 10 }));
        chartInstance.current = new Chart(chartRef.current.getContext('2d'), { type: 'line', data: { labels: Array.from({ length: params.years + 1 }, (_, i) => currentYear + i), datasets: [{ label: 'Median', data: results.medianPathData, borderColor: primaryColor, borderWidth: 3, pointRadius: 0, tension: 0.4, order: 1 }, ...styledDS] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: bgCard, titleColor: foregroundColor, bodyColor: mutedForegroundColor, borderColor: borderCard, borderWidth: 1, padding: 12, callbacks: { title: (items) => `${items[0].label} (Age: ${params.age + (parseInt(items[0].label) - currentYear)})`, label: (context) => context.dataset.label === 'Median' ? `Median: ${formatCurrency(context.raw, curLabel.currency, curLabel.locale)}` : context.dataset.label === 'Earliest Failure' ? `Early Fail: ${formatCurrency(context.raw, curLabel.currency, curLabel.locale)}` : '' } } }, scales: { y: { beginAtZero: true, max: Math.max(results.p90End, totalNow) * 1.25, grid: { color: getColor(getV('--chart-grid', 'rgba(255,255,255,0.05)')) }, ticks: { color: getColor(getV('--chart-text', '#94a3b8')), callback: (v) => `${curLabel.symbol}${v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'k' : v}` } }, x: { grid: { color: getColor(getV('--chart-grid', 'rgba(255,255,255,0.05)')) }, ticks: { color: getColor(getV('--chart-text', '#94a3b8')) } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } } });
      }, [results, theme, isClient, params.years, params.age]);

      if (!isClient) return null;

      return (
        <div className="flex h-screen w-full flex-col lg:overflow-hidden bg-[hsl(var(--background))] text-[hsl(var(--foreground))] transition-colors duration-300 font-sans overflow-y-auto lg:overflow-y-hidden">
          <header className="sticky top-0 lg:static flex h-16 shrink-0 items-center justify-between border-b border-[hsl(var(--border))] px-6 bg-[hsl(var(--card))]/80 backdrop-blur z-20">
            <div className="flex items-center gap-3">
              <div className="flex h-8 w-8 items-center justify-center rounded-lg border border-[hsl(var(--border))] bg-[image:var(--card-gradient)] shadow-[0_0_15px_-3px_hsl(var(--primary)/0.2)]"><Leaf className="h-4 w-4 text-[hsl(var(--primary))]" /></div>
              <div><h1 className="text-sm font-bold tracking-tight">{curLabel.title}</h1><p className="text-[10px] text-[hsl(var(--muted-foreground))]">Monte Carlo Simulation</p></div>
            </div>
            <div className="flex items-center gap-2">
              <label className="hidden sm:block text-[10px] uppercase tracking-wider text-[hsl(var(--muted-foreground))] font-bold">Theme</label>
              <select value={theme} onChange={(e) => setTheme(e.target.value)} className="h-8 rounded-lg border border-[hsl(var(--border))] bg-[hsl(var(--card))] px-3 py-1 text-xs outline-none focus:ring-2 focus:ring-[hsl(var(--primary))/50] font-medium shadow-sm hover:border-[hsl(var(--primary))/50]">
                <option value="zinc">Zinc (Dark)</option><option value="sage">Sage (Dark)</option><option value="light">Light</option>
              </select>
            </div>
          </header>

          <div className="flex flex-1 flex-col lg:flex-row overflow-hidden min-h-0">
            <aside className="w-full lg:w-[420px] flex-shrink-0 border-b lg:border-b-0 lg:border-r border-[hsl(var(--border))] bg-[hsl(var(--background))] overflow-y-auto custom-scrollbar p-6 space-y-6">
              <CollapsibleCard title="Setup" icon={User}>
                <div className="space-y-4">
                  <div className="space-y-1.5">
                    <label className="text-xs font-semibold text-[hsl(var(--muted-foreground))]">Region</label>
                    <div className="flex bg-[hsl(var(--muted))] rounded-lg p-1 shadow-sm w-full">
                      {['US', 'CA', 'EU'].map(c => (
                        <button key={c} onClick={() => setParams(p => ({ ...p, country: c }))} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-colors ${params.country === c ? 'bg-[hsl(var(--card))] text-[hsl(var(--primary))] shadow-sm' : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--foreground))]'}`}>
                          {c === 'US' ? 'ðŸ‡ºðŸ‡¸ USA' : c === 'CA' ? 'ðŸ‡¨ðŸ‡¦ Canada' : 'ðŸ‡ªðŸ‡º EU'}
                        </button>
                      ))}
                    </div>
                  </div>
                  <FormInput label="Current Age" type="number" value={params.age} min={1} max={100} onChange={(v) => handleNumChange('age', v, 1, 100)} />
                  <FormInput label="Years to Project" type="number" value={params.years} min={1} max={100} onChange={(v) => handleNumChange('years', v, 1, 100)} />
                  <FormInput label="Iterations" type="number" value={params.simulations} min={100} max={1000} onChange={(v) => handleNumChange('simulations', v, 100, 1000)} lazy={true} />
                </div>
              </CollapsibleCard>

              <CollapsibleCard title={`Assets (${curLabel.currency})`} icon={Coins}>
                <div className="space-y-4">
                  <CurrencyInput label={curLabel.tfsa} value={params.tfsa} tooltip={curLabel.tfsaTooltip} currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('tfsa', v)} max={5000000} />
                  <CurrencyInput label={curLabel.rrsp} value={params.rrsp} tooltip={curLabel.rrspTooltip} currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('rrsp', v)} max={10000000} />
                  <CurrencyInput label={curLabel.nonreg} value={params.nonreg} tooltip={curLabel.nonregTooltip} currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('nonreg', v)} max={10000000} />
                  <div className="h-px w-full bg-[hsl(var(--border))] my-4" /><CurrencyInput label={`Cash / Fixed (${curLabel.symbol})`} value={params.cash} tooltip="Excluded from equity mix" currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('cash', v)} max={10000000} />
                  <div className="pt-2"><Slider label="Equity Mix" value={params.stockAlloc} min={0} max={100} displayValue={`${params.stockAlloc}% Stocks / ${100 - params.stockAlloc}% Bonds`} onChange={(v) => handleNumChange('stockAlloc', v)} /></div>
                </div>
              </CollapsibleCard>

              <CollapsibleCard title="Assumptions" icon={Sliders}>
                <div className="space-y-5">
                  <div className="grid grid-cols-2 gap-4 relative">
                    <div className="absolute top-[34px] left-[50%] -translate-x-[50%] z-10 text-[hsl(var(--primary))/50] hidden sm:block"><Link2 className="h-3.5 w-3.5" /></div>
                    <CurrencyInput label={`Annual Spend (${curLabel.symbol})`} value={params.withdrawalAmount} tooltip="Total spending in today's dollars." currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('withdrawalAmount', v, totalNow * 0.5)} />
                    <FormInput label="Rate (%)" type="number" step="0.0001" value={params.withdrawalRate} tooltip="Calculated initial withdrawal rate." onChange={handleRateChange} min={0} max={50} />
                  </div>
                  <div className="grid grid-cols-2 gap-4 items-end">
                    <FormInput label="Inflation (%)" type="number" step="0.1" value={params.inflation} onChange={(v) => handleNumChange('inflation', v, 0, 200)} />
                    <div className="flex items-center pb-2">
                      <label className="flex items-center cursor-pointer">
                        <input type="checkbox" checked={params.flexibleSpending} onChange={(e) => setParams({ ...params, flexibleSpending: e.target.checked })} className="sr-only peer" />
                        <div className="relative w-9 h-5 bg-[hsl(var(--muted))] rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[hsl(var(--primary))] shadow-sm"></div>
                        <span className="ms-2 text-xs font-semibold text-[hsl(var(--muted-foreground))]">Flex Spend</span>
                      </label><Tooltip text="Skip inflation raise in down years" />
                    </div>
                  </div>
                  <div className="h-px w-full bg-[hsl(var(--border))]" />
                  <div className="grid grid-cols-2 gap-4">
                    <FormInput label="Stock Return (%)" type="number" step="0.1" value={params.marketReturn} onChange={(v) => handleNumChange('marketReturn', v, 0, 100)} />
                    <FormInput label="Variance (%)" type="number" step="0.1" value={params.marketVariance} onChange={(v) => handleNumChange('marketVariance', v, 0, 100)} tooltip="Std Dev (12-13% typical)" />
                    <FormInput label="Fixed Income (%)" type="number" step="0.1" value={params.bondReturn} onChange={(v) => handleNumChange('bondReturn', v, 0, 100)} />
                    <FormInput label="MER Fee (%)" type="number" step="0.01" value={params.merFee} onChange={(v) => handleNumChange('merFee', v, 0, 50)} />
                  </div>
                </div>
              </CollapsibleCard>

              <CollapsibleCard title="Future Income" icon={Banknote}>
                <div className="space-y-6">
                  <div className="grid grid-cols-1 sm:grid-cols-5 gap-4 items-end">
                    <div className="sm:col-span-3"><CurrencyInput label={`Income (${curLabel.symbol})`} value={params.currentIncome} tooltip="Active employment or other sources" currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('currentIncome', v)} max={100000000} /></div>
                    <div className="sm:col-span-2 pb-1"><Slider label="Until" value={params.currentIncomeEnd} min={currentYear + 1} max={currentYear + params.years} onChange={(v) => handleNumChange('currentIncomeEnd', v)} /></div>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-5 gap-4 items-end">
                    <div className="sm:col-span-3"><CurrencyInput label={curLabel.govPension} value={params.otherIncome} tooltip={curLabel.govPensionTooltip} currency={curLabel.currency} locale={curLabel.locale} onChange={(v) => handleCurrencyChange('otherIncome', v)} max={1000000} /></div>
                    <div className="sm:col-span-2 pb-1"><Slider label="Starts" value={params.otherIncomeStart} min={currentYear + 1} max={currentYear + params.years} onChange={(v) => handleNumChange('otherIncomeStart', v)} /></div>
                  </div>
                </div>
              </CollapsibleCard>

              <div className="flex flex-col gap-3 pt-2">
                <button onClick={handleReRoll} className="flex h-11 w-full items-center justify-center gap-2 rounded-xl bg-[image:var(--primary-gradient)] text-[hsl(var(--primary-foreground))] font-bold shadow-lg border-0 hover:opacity-90"><Dices className="h-4 w-4" /> Recalculate (new seed)</button>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={handleShare} className="h-9 w-full flex items-center justify-center gap-2 rounded-lg bg-[hsl(var(--muted))] text-[hsl(var(--foreground))] text-xs font-semibold transition-colors hover:bg-[hsl(var(--border))] hover:text-[hsl(var(--primary))] shadow-sm"><Share2 className="h-3 w-3" /> {shareText}</button>
                  <button onClick={handleReset} className="h-9 w-full rounded-lg bg-[hsl(var(--muted))] text-[hsl(var(--muted-foreground))] text-xs font-semibold transition-colors hover:bg-[hsl(var(--border))] hover:text-[hsl(var(--primary))] shadow-sm">Reset Defaults</button>
                </div>
              </div>
            </aside>

            <main className="flex-1 bg-[hsl(var(--background))] custom-scrollbar p-4 lg:p-8 overflow-y-auto relative">
              <div className="mx-auto max-w-6xl space-y-6">
                <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                  <StatCard title="Total Portfolio" value={formatCurrency(totalNow, curLabel.currency, curLabel.locale)} subtitle="Current value" isGradient={true} highlight={true} />
                  <StatCard title="Required for 100%" value={formatCurrency(results.target100, curLabel.currency, curLabel.locale)} subtitle="Portfolio needed today" />
                  <StatCard title="Success Rate" value={`${results.successRate}%`} highlight={results.successRate > 90} />
                  <StatCard title="Median Balance" value={formatCurrency(results.medianEnd, curLabel.currency, curLabel.locale)} />
                  <StatCard title="Worst Decile (10th)" value={formatCurrency(results.p10End, curLabel.currency, curLabel.locale)} />
                  <StatCard title="Best Decile (90th)" value={formatCurrency(results.p90End, curLabel.currency, curLabel.locale)} />
                </div>
                
                <div className="space-y-6">
                  <CollapsibleCard title="Portfolio Projection" icon={Leaf}>
                    <div className="mb-4"><p className="text-xs font-medium text-[hsl(var(--muted-foreground))]">{params.simulations} Monte Carlo iterations based on applied volatility</p></div>
                    <div className="h-[400px] w-full relative"><canvas ref={chartRef}></canvas></div>
                  </CollapsibleCard>

                  <CollapsibleCard title="Strategy Guidance" icon={ShieldCheck}>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {getAdvice().map((adv, idx) => (
                        <div key={idx} className={`flex gap-3 p-3 rounded-xl border text-xs leading-relaxed ${adv.type === 'success' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-500' : adv.type === 'danger' ? 'bg-rose-500/10 border-rose-500/20 text-rose-500' : adv.type === 'warning' ? 'bg-amber-500/10 border-amber-500/20 text-amber-500' : 'bg-sky-500/10 border-sky-500/20 text-sky-500'}`}>
                          <div className="shrink-0 mt-0.5"><Info className="h-3 w-3" /></div>
                          <div>{adv.text}</div>
                        </div>
                      ))}
                    </div>
                  </CollapsibleCard>

                  <CollapsibleCard title="Detailed Projection" icon={Sliders}>
                    <div className="p-0 border border-[hsl(var(--border))] rounded-xl overflow-hidden flex flex-col">
                      <div className="p-5 border-b border-[hsl(var(--border))] flex flex-col sm:flex-row justify-between sm:items-center gap-3 bg-[hsl(var(--card))]">
                        <div><p className="text-xs font-medium text-[hsl(var(--muted-foreground))]">Median scenario year-over-year breakdown.</p></div>
                        <div className="rounded-lg border border-[hsl(var(--primary))/30] bg-[hsl(var(--primary))/10] text-[hsl(var(--primary))] px-3 py-1.5 text-[10px] font-mono font-bold tracking-wider w-fit">{curLabel.tableNominal}</div>
                      </div>
                      <div className="max-h-[500px] overflow-auto custom-scrollbar bg-[hsl(var(--background))]">
                        <table className="w-full text-left text-sm whitespace-nowrap">
                          <thead className="sticky top-0 bg-[hsl(var(--background))] shadow-sm z-10 font-bold uppercase tracking-wider text-[hsl(var(--muted-foreground))] text-xs">
                            <tr className="border-b border-[hsl(var(--border))]">
                              <th className="px-5 py-3">Year</th><th className="px-5 py-3">Age</th><th className="px-5 py-3 text-right">Start Bal</th><th className="px-5 py-3 text-right">Withdraw</th><th className="px-5 py-3 text-right">Income</th><th className="px-5 py-3 text-right">Growth</th><th className="px-5 py-3 text-right text-[hsl(var(--primary))]">End Bal</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-[hsl(var(--border))] text-[hsl(var(--foreground))]">
                            {results.medianPathData.map((bal, idx) => {
                              if (idx === 0) return null;
                              const agg = results.yearlyAggregates[idx];
                              if(!agg) return null;
                              const prevBal = results.medianPathData[idx - 1], withdraw = getMedian(agg.withdrawals), income = getMedian(agg.incomes), growth = getMedian(agg.growths);
                              return (
                                <tr key={idx} className="hover:bg-[hsl(var(--muted))/30] transition-colors">
                                  <td className="px-5 py-3 text-[hsl(var(--muted-foreground))] font-medium">{currentYear + idx}</td>
                                  <td className="px-5 py-3 text-[hsl(var(--muted-foreground))] font-medium">{params.age + idx}</td>
                                  <td className="px-5 py-3 text-right font-mono">{formatCurrency(prevBal, curLabel.currency, curLabel.locale)}</td>
                                  <td className="px-5 py-3 text-right font-mono text-rose-500 font-medium">-{formatCurrency(withdraw, curLabel.currency, curLabel.locale)}</td>
                                  <td className="px-5 py-3 text-right font-mono text-[hsl(var(--primary))] font-medium">+{formatCurrency(income, curLabel.currency, curLabel.locale)}</td>
                                  <td className="px-5 py-3 text-right font-mono text-emerald-500 font-medium">{formatCurrency(growth, curLabel.currency, curLabel.locale)}</td>
                                  <td className="px-5 py-3 text-right font-mono font-bold">{formatCurrency(bal, curLabel.currency, curLabel.locale)}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </CollapsibleCard>
                </div>
                <div className="text-center text-xs text-[hsl(var(--muted-foreground))] pb-8 space-y-1"><p>Disclaimer: Educational purposes only. Gaussian distribution used for Monte Carlo.</p><p>Note: Values are exclusive of taxes. Investment fees deducted. Actual tax liability depends on jurisdiction.</p></div>
              </div>
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>