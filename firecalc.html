<!-- 
    =======================================================================
    Â© 2025 Corwin. All Rights Reserved.
    
    Official Tool for: https://cor.win/
    
    This source code is the intellectual property of Corwin. 
    Unauthorized reproduction, distribution, modification, or use of this 
    code for commercial purposes is strictly prohibited without express 
    written permission.
    =======================================================================
-->
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corwin's FIRE Calc (Canada)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base Variables (Zinc Dark Default) */
        :root {
            --radius: 0.5rem;
            --background: 240 10% 3.9%;
            --foreground: 0 0% 98%;
            --card: 240 10% 3.9%;
            --card-foreground: 0 0% 98%;
            --popover: 240 10% 3.9%;
            --popover-foreground: 0 0% 98%;
            --primary: 142 76% 36%; /* Emerald */
            --primary-foreground: 355.7 100% 97.3%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 240 5% 64.9%;
            --accent: 240 3.7% 15.9%;
            --accent-foreground: 0 0% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 142 76% 36%;
            
            /* Chart Specifics */
            --chart-grid: #27272a;
            --chart-text: #71717a;
        }

        /* Slate Dark Theme */
        [data-theme="slate"] {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%; /* Blue-ish */
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
            
            --chart-grid: #1e293b;
            --chart-text: #94a3b8;
        }

        /* Light Theme */
        [data-theme="light"] {
            --background: 0 0% 100%;
            --foreground: 240 10% 3.9%;
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 240 10% 3.9%;
            --primary: 142 76% 36%; /* Emerald */
            --primary-foreground: 355.7 100% 97.3%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%;
            --muted-foreground: 240 3.8% 46.1%;
            --accent: 240 4.8% 95.9%;
            --accent-foreground: 240 5.9% 10%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 142 76% 36%;

            --chart-grid: #e4e4e7;
            --chart-text: #52525b;
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: hsl(var(--border));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--muted-foreground));
        }

        /* Shadcn-like Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: hsl(var(--foreground));
            border: 1px solid hsl(var(--border));
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: hsl(var(--border));
            border-radius: 1px;
        }
        /* Firefox */
        input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border: 1px solid hsl(var(--border));
            border-radius: 50%;
            background: hsl(var(--foreground));
            cursor: pointer;
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: hsl(var(--border));
            border-radius: 1px;
        }

        /* Tooltip Logic */
        .tooltip-trigger:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .tooltip-content {
            transform: translateY(4px);
            transition: all 0.2s ease-out;
            font-family: 'Inter', sans-serif !important;
        }

        /* Shadcn Input Focus Ring Helper */
        .shadcn-input:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 1px hsl(var(--ring)); 
        }
        
        .border-color-trans {
            transition: border-color 0.3s;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden text-foreground bg-background">

    <!-- Header (Fixed) -->
    <header class="h-16 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 flex items-center justify-between px-6 flex-shrink-0 z-50 transition-colors duration-300">
        <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded bg-primary/10 border border-primary/20 flex items-center justify-center text-primary">
                <i class="fa-solid fa-leaf"></i>
            </div>
            <div>
                <h1 class="text-sm font-semibold tracking-tight">Corwin's FIRE Calc (Canada)</h1>
                <p class="text-[10px] text-muted-foreground">Monte Carlo Simulation</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:flex items-center gap-2">
                <label for="themeSelect" class="text-[10px] uppercase tracking-wider text-muted-foreground font-medium">Theme</label>
                <select id="themeSelect" class="h-8 w-32 rounded-md border border-input bg-background px-3 py-1 text-xs shadow-sm focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    <option value="zinc">Zinc (Dark)</option>
                    <option value="slate">Slate (Dark)</option>
                    <option value="light">Light Mode</option>
                </select>
            </div>
            <div class="text-right border-l border-border pl-4">
                <div class="text-[10px] uppercase tracking-wider text-muted-foreground font-medium">Total Portfolio</div>
                <div class="text-lg font-bold font-mono text-primary" id="displayTotalPortfolio">$0.00</div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        
        <!-- LEFT SIDEBAR (Inputs) -->
        <aside class="w-full lg:w-[420px] bg-card border-r border-border overflow-y-auto flex-shrink-0 p-6 custom-scrollbar transition-colors duration-300">
            
            <div class="space-y-6">
                
                <!-- Profile Card -->
                <div class="rounded-xl border border-border bg-card p-4 shadow-sm">
                    <h3 class="text-sm font-medium mb-4 flex items-center gap-2">
                        <i class="fa-regular fa-user text-muted-foreground"></i> Profile
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-medium uppercase tracking-wider text-muted-foreground">Age</label>
                            <input type="number" id="age" value="42" min="1" max="100" 
                                class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-medium uppercase tracking-wider text-muted-foreground">Years to Project</label>
                            <input type="number" id="years" value="50" min="1" max="100" 
                                class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                        </div>
                    </div>
                </div>

                <!-- Assets Card -->
                <div class="rounded-xl border border-border bg-card p-4 shadow-sm">
                    <h3 class="text-sm font-medium mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-coins text-muted-foreground"></i> Assets (CAD)
                    </h3>
                    <div class="space-y-4">
                        <!-- TFSA -->
                        <div class="space-y-1.5 relative group">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-medium text-muted-foreground">TFSA</label>
                                <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                    <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                        Tax-Free Savings Account. Limit: $5M.
                                    </div>
                                </i>
                            </div>
                            <input type="text" id="tfsa" value="$100,000" data-max="5000000" class="save-input currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                        </div>

                        <!-- RRSP -->
                        <div class="space-y-1.5 relative group">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-medium text-muted-foreground">RRSP / LIRA</label>
                                <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                    <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                        Registered Retirement Savings Plan. Limit: $10M.
                                    </div>
                                </i>
                            </div>
                            <input type="text" id="rrsp" value="$250,000" data-max="10000000" class="save-input currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                        </div>

                        <!-- Non-Reg -->
                        <div class="space-y-1.5 relative group">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-medium text-muted-foreground">Non-Registered</label>
                                <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                    <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                        Taxable Accounts. Limit: $10M.
                                    </div>
                                </i>
                            </div>
                            <input type="text" id="nonreg" value="$50,000" data-max="10000000" class="save-input currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                        </div>

                        <div class="h-px bg-border my-2"></div>

                        <!-- Cash -->
                        <div class="space-y-1.5 relative group">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-medium text-muted-foreground">Cash / Money Market</label>
                                <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                    <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                        Low risk, Fixed Income rate. Limit: $10M.
                                    </div>
                                </i>
                            </div>
                            <input type="text" id="cash" value="$20,000" data-max="10000000" class="save-input currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                        </div>

                        <!-- Mix Slider -->
                        <div class="pt-2">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-[10px] font-medium uppercase tracking-wider text-primary">Asset Mix (Inv)</label>
                                <span id="mixLabel" class="text-[10px] font-mono text-muted-foreground">80% Stocks</span>
                            </div>
                            <input type="range" id="stockAlloc" min="0" max="100" value="80" class="save-input">
                            <div class="flex justify-between text-[10px] text-muted-foreground mt-1">
                                <span>Bonds</span>
                                <span>Stocks</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assumptions Card -->
                <div class="rounded-xl border border-border bg-card p-4 shadow-sm">
                    <h3 class="text-sm font-medium mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-muted-foreground"></i> Assumptions
                    </h3>
                    
                    <div class="space-y-5">
                        <!-- Withdrawal Row -->
                        <div class="grid grid-cols-2 gap-4 relative">
                            <!-- Link Icon -->
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-[-2px] z-10 text-muted-foreground text-[10px]">
                                <i class="fa-solid fa-link"></i>
                            </div>

                            <div class="space-y-1.5 group relative">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">Annual Spend ($)</label>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full -right-4 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                            Master Value. Annual spending in today's dollars.
                                        </div>
                                    </i>
                                </div>
                                <input type="text" id="withdrawalAmount" value="$0" class="currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm font-mono shadow-sm transition-colors">
                            </div>

                            <div class="space-y-1.5 group relative">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">Rate (%)</label>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                            Calculated withdrawal rate based on portfolio value.
                                        </div>
                                    </i>
                                </div>
                                <input type="number" step="0.01" id="withdrawalRate" value="4.0" min="0" max="50" class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                        </div>

                        <!-- Inflation & Flex -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1.5 group relative">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">Inflation (%)</label>
                                </div>
                                <input type="number" step="0.1" id="inflation" value="2.8" min="0" max="200" class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                            <div class="flex items-center pt-6">
                                <label class="flex items-center cursor-pointer group">
                                    <input type="checkbox" id="flexibleSpending" class="save-input sr-only peer">
                                    <div class="relative w-9 h-5 bg-secondary peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-muted-foreground after:border-border after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary peer-checked:after:bg-white peer-checked:after:border-white"></div>
                                    <span class="ms-2 text-xs font-medium text-muted-foreground group-hover:text-primary transition-colors">Flex Spend</span>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground ml-2 cursor-help tooltip-trigger relative">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none normal-case text-left">
                                            Skip inflation raise in years where portfolio value drops.
                                        </div>
                                    </i>
                                </label>
                            </div>
                        </div>

                        <div class="h-px bg-border"></div>

                        <!-- Returns Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1.5 relative group">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">Stock Rtn (%)</label>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full left-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                            Arithmetic Mean. Geometric mean will be lower.
                                        </div>
                                    </i>
                                </div>
                                <input type="number" step="0.1" id="marketReturn" value="8.0" min="0" max="100" class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                            <div class="space-y-1.5 relative group">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">Variance (%)</label>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                            Std Deviation. 12-15% typical for stocks.
                                        </div>
                                    </i>
                                </div>
                                <input type="number" step="0.1" id="marketVariance" value="12.0" min="0" max="100" class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                            <div class="space-y-1.5 relative group">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">Fixed Inc (%)</label>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full left-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                            Return for Bonds/Cash. 0% volatility assumed.
                                        </div>
                                    </i>
                                </div>
                                <input type="number" step="0.1" id="bondReturn" value="2.5" min="0" max="100" class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                            <div class="space-y-1.5 relative group">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-muted-foreground">MER Fee (%)</label>
                                    <i class="fa-solid fa-circle-info text-[10px] text-muted-foreground cursor-help tooltip-trigger">
                                        <div class="tooltip-content invisible opacity-0 absolute z-50 bottom-full right-0 mb-2 w-56 p-3 bg-popover text-xs text-popover-foreground rounded-md border border-border shadow-xl pointer-events-none">
                                            Management Expense Ratio. Deducted annually from portfolio growth. Limit: 50%.
                                        </div>
                                    </i>
                                </div>
                                <input type="number" step="0.01" id="merFee" value="0.25" min="0" max="50" class="save-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income Card -->
                <div class="rounded-xl border border-border bg-card p-4 shadow-sm">
                    <h3 class="text-sm font-medium mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-hand-holding-dollar text-muted-foreground"></i> Income
                    </h3>
                    <div class="space-y-5">
                        <!-- Current Income -->
                        <div class="grid grid-cols-5 gap-3 items-end">
                            <div class="col-span-3 space-y-1.5">
                                <label class="text-xs font-medium text-primary">Side Income ($)</label>
                                <input type="text" id="currentIncome" value="$0" data-max="100000000" class="save-input currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                            <div class="col-span-2 space-y-1">
                                <div class="flex justify-between text-[10px] text-muted-foreground">
                                    <span>Until:</span>
                                    <span id="currentIncomeEndLabel" class="text-foreground font-mono">2030</span>
                                </div>
                                <input type="range" id="currentIncomeEnd" min="2025" max="2075" value="2030" class="save-input">
                            </div>
                        </div>

                        <!-- OAS Income -->
                        <div class="grid grid-cols-5 gap-3 items-end">
                            <div class="col-span-3 space-y-1.5">
                                <label class="text-xs font-medium text-primary">CPP/OAS ($)</label>
                                <input type="text" id="otherIncome" value="$18,000" data-max="1000000" class="save-input currency-input shadcn-input flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors">
                            </div>
                            <div class="col-span-2 space-y-1">
                                <div class="flex justify-between text-[10px] text-muted-foreground">
                                    <span>Start:</span>
                                    <span id="otherIncomeStartLabel" class="text-foreground font-mono">2048</span>
                                </div>
                                <input type="range" id="otherIncomeStart" min="2025" max="2075" value="2048" class="save-input">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-2 flex flex-col gap-2">
                    <button id="calcBtn" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 shadow-[0_0_15px_-3px_hsl(var(--primary)/0.4)]">
                        <i class="fa-solid fa-dice mr-2"></i> Recalculate (new seed)
                    </button>
                    <button id="resetBtn" class="w-full inline-flex items-center justify-center rounded-md text-xs font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-secondary text-secondary-foreground hover:bg-secondary/80 h-8 px-3">
                        Reset Defaults
                    </button>
                </div>

            </div>
        </aside>

        <!-- RIGHT CONTENT (Results) - Independently Scrollable -->
        <main class="flex-1 overflow-y-auto bg-background p-4 lg:p-8 custom-scrollbar transition-colors duration-300">
            <div class="max-w-5xl mx-auto space-y-6">
                
                <!-- Chart Card -->
                <div class="rounded-xl border border-border bg-card text-card-foreground shadow-sm transition-colors duration-300">
                    <div class="flex flex-col space-y-1.5 p-6 pb-2">
                        <h3 class="font-semibold leading-none tracking-tight">Monte Carlo Simulation</h3>
                        <p class="text-sm text-muted-foreground">100 random market scenarios based on your volatility inputs.</p>
                    </div>
                    <div class="p-6 pt-0 h-[400px]">
                        <canvas id="fireChart"></canvas>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="rounded-xl border border-border bg-card p-4 shadow-sm transition-colors duration-300">
                        <div class="text-xs font-medium text-muted-foreground mb-1">Success Rate</div>
                        <div class="text-2xl font-bold text-primary" id="successRate">--%</div>
                        <div class="text-[10px] text-muted-foreground">Runs > $0</div>
                    </div>
                    <div class="rounded-xl border border-border bg-card p-4 shadow-sm transition-colors duration-300">
                        <div class="text-xs font-medium text-muted-foreground mb-1">Median End Balance</div>
                        <div class="text-2xl font-bold tracking-tight" id="medianEnd">--</div>
                        <div class="text-[10px] text-muted-foreground">50th Percentile</div>
                    </div>
                    <div class="rounded-xl border border-border bg-card p-4 shadow-sm transition-colors duration-300">
                        <div class="text-xs font-medium text-muted-foreground mb-1">10th Percentile (Poor)</div>
                        <div class="text-2xl font-bold text-rose-400 tracking-tight" id="p10End">--</div>
                        <div class="text-[10px] text-muted-foreground">Unlucky Scenario</div>
                    </div>
                    <div class="rounded-xl border border-border bg-card p-4 shadow-sm transition-colors duration-300">
                        <div class="text-xs font-medium text-muted-foreground mb-1">90th Percentile (Great)</div>
                        <div class="text-2xl font-bold text-blue-400 tracking-tight" id="p90End">--</div>
                        <div class="text-[10px] text-muted-foreground">Lucky Scenario</div>
                    </div>
                </div>

                <!-- Table Card -->
                <div class="rounded-xl border border-border bg-card text-card-foreground shadow-sm overflow-hidden flex flex-col h-[600px] transition-colors duration-300">
                    <div class="flex flex-col space-y-1.5 p-6 pb-4 border-b border-border bg-card/50">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold leading-none tracking-tight">Detailed Projection</h3>
                                <p class="text-sm text-muted-foreground mt-1">Median scenario year-by-year breakdown.</p>
                            </div>
                            <span class="text-[10px] text-muted-foreground font-mono bg-secondary px-2 py-1 rounded border border-border">Values are Nominal</span>
                        </div>
                    </div>
                    
                    <div class="overflow-auto custom-scrollbar flex-1 p-0">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-card sticky top-0 z-10">
                                <tr class="border-b border-border text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    <th class="p-4 font-medium">Year</th>
                                    <th class="p-4 font-medium">Age</th>
                                    <th class="p-4 text-right font-medium">Start Bal</th>
                                    <th class="p-4 text-right font-medium text-rose-400/90">Withdrawal</th>
                                    <th class="p-4 text-right font-medium text-emerald-400/80">Income</th>
                                    <th class="p-4 text-right font-medium text-emerald-600/90">Growth</th>
                                    <th class="p-4 text-right font-medium">End Bal</th>
                                    <th class="p-4 text-right font-medium text-purple-400/90">Buying Power</th>
                                </tr>
                            </thead>
                            <tbody id="projectionBody" class="divide-y divide-border text-muted-foreground">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="text-center text-xs text-muted-foreground pb-8 space-y-1">
                    <p>Disclaimer: Educational purposes only. Gaussian distribution used for Monte Carlo.</p>
                    <p>Note: Values are <strong>PRE-TAX</strong>. Investment fees deducted. Actual tax liability depends on jurisdiction.</p>
                </div>

            </div>
        </main>
    </div>

    <!-- Logic Script -->
    <script>
        // --- Utilities ---
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(num);
        };

        const parseCurrencyInput = (val) => {
             const clean = String(val).replace(/[^0-9.]/g, '');
             return parseFloat(clean) || 0;
        }
        
        const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

        // SEEDED Random Number Generator
        let baseSeed = 1; 
        
        function seededRandom() {
            var x = Math.sin(masterSeed++) * 10000;
            return x - Math.floor(x);
        }

        function randn_bm() {
            let u = 0, v = 0;
            while(u === 0) u = seededRandom(); 
            while(v === 0) v = seededRandom();
            return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
        }

        function getMedian(values) {
            if(values.length === 0) return 0;
            values.sort((a, b) => a - b);
            const half = Math.floor(values.length / 2);
            if(values.length % 2) return values[half];
            return (values[half - 1] + values[half]) / 2.0;
        }

        let myChart = null;
        const currentYearGlobal = new Date().getFullYear();

        // --- STORAGE ---
        const STORAGE_KEY = 'canadianFireCalcData';

        function saveData() {
            const inputs = document.querySelectorAll('.save-input');
            const data = {};
            inputs.forEach(input => {
                if(input.classList.contains('currency-input')) {
                    data[input.id] = parseCurrencyInput(input.value);
                } 
                else if(input.type === 'checkbox') {
                    data[input.id] = input.checked;
                }
                else {
                    data[input.id] = input.value;
                }
            });
            data['withdrawalAmount'] = parseCurrencyInput(document.getElementById('withdrawalAmount').value);
            data['theme'] = document.getElementById('themeSelect').value; // Save Theme
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return false;
            try {
                const data = JSON.parse(stored);
                for (const [id, value] of Object.entries(data)) {
                    if(id === 'theme') {
                        setTheme(value);
                        document.getElementById('themeSelect').value = value;
                        continue;
                    }
                    const input = document.getElementById(id);
                    if (input) {
                        if (input.classList.contains('currency-input')) {
                            input.value = formatCurrency(value);
                        } 
                        else if(input.type === 'checkbox') {
                            input.checked = value;
                        }
                        else {
                            input.value = value;
                        }
                    }
                }
                // Update dependent labels
                const stocks = document.getElementById('stockAlloc').value;
                document.getElementById('mixLabel').innerText = `${stocks}% Stocks`;

                const incomeSlider = document.getElementById('currentIncomeEnd');
                document.getElementById('currentIncomeEndLabel').innerText = incomeSlider.value;
                
                const otherIncomeStartSlider = document.getElementById('otherIncomeStart');
                document.getElementById('otherIncomeStartLabel').innerText = otherIncomeStartSlider.value;

                return true;
            } catch (e) {
                console.error("Error loading data", e);
                return false;
            }
        }
        
        function resetData() {
            if(confirm("Reset all values to defaults?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- THEME LOGIC ---
        function setTheme(themeName) {
            // Remove previous theme class logic, using data attribute now
            document.documentElement.setAttribute('data-theme', themeName);
            // Re-render chart to pick up new colors
            calculate(); 
        }
        
        document.getElementById('themeSelect').addEventListener('change', (e) => {
            setTheme(e.target.value);
            saveData();
        });

        // --- Inputs ---
        const currencyInputs = document.querySelectorAll('.currency-input');
        currencyInputs.forEach(input => {
            input.addEventListener('focus', (e) => {
                const val = parseCurrencyInput(e.target.value);
                e.target.value = val === 0 ? '' : val;
            });
            input.addEventListener('blur', (e) => {
                let val = parseCurrencyInput(e.target.value);
                const max = parseFloat(e.target.getAttribute('data-max'));
                if (!isNaN(max) && val > max) val = max;
                if (e.target.id === 'withdrawalAmount') {
                    const total = getTotalPortfolio();
                    if (total > 0 && val > total * 0.5) val = total * 0.5;
                }
                e.target.value = formatCurrency(val);
                calculate(); 
                if(input.classList.contains('save-input')) saveData(); 
            });
            input.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') e.target.blur();
            });
        });
        
        document.querySelectorAll('input[type="number"]').forEach(input => {
            const enforceLimit = () => {
                const val = parseFloat(input.value);
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                if (!isNaN(min) && val < min) input.value = min;
                if (!isNaN(max) && val > max) input.value = max;
                calculate();
                if(input.classList.contains('save-input')) saveData();
            };
            input.addEventListener('change', enforceLimit);
        });

        const stockSlider = document.getElementById('stockAlloc');
        stockSlider.addEventListener('input', (e) => {
            document.getElementById('mixLabel').innerText = `${e.target.value}% Stocks`;
            calculate();
        });
        stockSlider.addEventListener('change', saveData); 

        // Sliders
        const yearsInput = document.getElementById('years');
        const incomeSlider = document.getElementById('currentIncomeEnd');
        const incomeLabel = document.getElementById('currentIncomeEndLabel');
        const otherIncomeStartSlider = document.getElementById('otherIncomeStart');
        const otherIncomeStartLabel = document.getElementById('otherIncomeStartLabel');

        function updateSliderRanges() {
            const yearsToProject = parseInt(yearsInput.value) || 50;
            const maxYear = currentYearGlobal + yearsToProject;
            
            [incomeSlider, otherIncomeStartSlider].forEach(slider => {
                const val = parseInt(slider.value);
                slider.min = currentYearGlobal;
                slider.max = maxYear;
                if (val > maxYear) slider.value = maxYear;
                if (val < currentYearGlobal) slider.value = currentYearGlobal;
            });
            
            incomeLabel.innerText = incomeSlider.value;
            otherIncomeStartLabel.innerText = otherIncomeStartSlider.value;
        }
        
        incomeSlider.addEventListener('input', (e) => {
            incomeLabel.innerText = e.target.value;
            calculate();
        });
        incomeSlider.addEventListener('change', saveData); 
        
        otherIncomeStartSlider.addEventListener('input', (e) => {
            otherIncomeStartLabel.innerText = e.target.value;
            calculate();
        });
        otherIncomeStartSlider.addEventListener('change', saveData);
        yearsInput.addEventListener('input', updateSliderRanges);

        // Sync Logic
        const withdrawalRateInput = document.getElementById('withdrawalRate');
        const withdrawalAmountInput = document.getElementById('withdrawalAmount');
        
        function getTotalPortfolio() {
             const tfsa = parseCurrencyInput(document.getElementById('tfsa').value);
             const rrsp = parseCurrencyInput(document.getElementById('rrsp').value);
             const nonreg = parseCurrencyInput(document.getElementById('nonreg').value);
             const cash = parseCurrencyInput(document.getElementById('cash').value);
             return tfsa + rrsp + nonreg + cash;
        }

        withdrawalRateInput.addEventListener('input', (e) => {
             let val = parseFloat(e.target.value);
             if (val > 50) val = 50; 
             const rate = val / 100;
             const total = getTotalPortfolio();
             const amount = total * rate;
             withdrawalAmountInput.value = formatCurrency(amount);
        });
        
        withdrawalRateInput.addEventListener('blur', (e) => {
            let val = parseFloat(e.target.value);
            if (val > 50) { e.target.value = 50; calculate(); }
            if (val < 0) { e.target.value = 0; calculate(); }
        });

        withdrawalAmountInput.addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            const total = getTotalPortfolio();
            if (total > 0) {
                const rate = (amount / total) * 100;
                withdrawalRateInput.value = parseFloat(rate.toFixed(4));
            }
            calculate();
        });

        // --- Calc Engine ---
        function calculate() {
            masterSeed = baseSeed; // Reset to the current base seed (ensures stability on inputs, but allows re-roll)

            // Gather
            const age = parseInt(document.getElementById('age').value);
            const years = parseInt(document.getElementById('years').value);
            
            const totalPortfolio = getTotalPortfolio();
            document.getElementById('displayTotalPortfolio').innerText = formatCurrency(totalPortfolio);

            const inflationRate = parseFloat(document.getElementById('inflation').value) / 100;
            const marketMean = parseFloat(document.getElementById('marketReturn').value) / 100;
            const marketStdDev = parseFloat(document.getElementById('marketVariance').value) / 100;
            const bondReturn = parseFloat(document.getElementById('bondReturn').value) / 100;
            const merFee = parseFloat(document.getElementById('merFee').value) / 100;
            const flexibleSpending = document.getElementById('flexibleSpending').checked;

            const stockPct = parseInt(document.getElementById('stockAlloc').value) / 100;
            const bondPct = 1 - stockPct;

            const otherIncomeAmt = parseCurrencyInput(document.getElementById('otherIncome').value);
            const otherIncomeYear = parseInt(document.getElementById('otherIncomeStart').value);
            const currentIncomeAmt = parseCurrencyInput(document.getElementById('currentIncome').value);
            const currentIncomeEndYear = parseInt(incomeSlider.value); 

            // Withdrawal Master Logic
            let initialWithdrawalDollar;
            let withdrawRate; 

            if (document.activeElement === withdrawalRateInput) {
                withdrawRate = parseFloat(withdrawalRateInput.value) / 100;
                initialWithdrawalDollar = totalPortfolio * withdrawRate;
                withdrawalAmountInput.value = formatCurrency(initialWithdrawalDollar);
            } else {
                initialWithdrawalDollar = parseCurrencyInput(withdrawalAmountInput.value);
                if (totalPortfolio > 0) {
                    withdrawRate = initialWithdrawalDollar / totalPortfolio;
                    if(document.activeElement !== withdrawalAmountInput) {
                         withdrawalRateInput.value = parseFloat((withdrawRate * 100).toFixed(4));
                    }
                } else {
                    withdrawRate = 0;
                }
            }

            // Blended Returns
            const tfsa = parseCurrencyInput(document.getElementById('tfsa').value);
            const rrsp = parseCurrencyInput(document.getElementById('rrsp').value);
            const nonreg = parseCurrencyInput(document.getElementById('nonreg').value);
            const cash = parseCurrencyInput(document.getElementById('cash').value);
            
            const investedTotal = tfsa + rrsp + nonreg;
            const cashTotal = cash;
            const grandTotal = investedTotal + cashTotal;
            
            const totalStock = investedTotal * stockPct;
            const totalBond = (investedTotal * bondPct) + cashTotal;
            
            const wStock = (grandTotal > 0) ? totalStock / grandTotal : 0;
            const wBond = (grandTotal > 0) ? totalBond / grandTotal : 0;

            let blendedMean = (wStock * marketMean) + (wBond * bondReturn);
            blendedMean = blendedMean - merFee;
            const blendedStdDev = wStock * marketStdDev;

            // Monte Carlo (100 Runs)
            const numSimulations = 100;
            const simulationDatasets = [];
            let successes = 0;
            let finalBalances = [];
            let earliestFailureIndex = -1;
            let minFailureStep = Infinity;

            let yearlyAggregates = Array(years + 1).fill(null).map(() => ({
                balances: [], withdrawals: [], incomes: [], growths: []
            }));

            // Init Year 0
            for(let s=0; s<numSimulations; s++) yearlyAggregates[0].balances.push(totalPortfolio);

            for (let s = 0; s < numSimulations; s++) {
                let simBal = totalPortfolio;
                let simWithdrawal = initialWithdrawalDollar;
                let dataPoints = [simBal]; 
                let runFailedStep = Infinity; 

                for (let i = 1; i <= years; i++) {
                    const year = currentYearGlobal + i;
                    
                    // Local wrapper for seeded random
                    let u = 0, v = 0;
                    while(u === 0) { var x = Math.sin(masterSeed++) * 10000; u = x - Math.floor(x); }
                    while(v === 0) { var y = Math.sin(masterSeed++) * 10000; v = y - Math.floor(y); }
                    const rnd = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
                    
                    const randomReturn = blendedMean + (blendedStdDev * rnd);
                    
                    let simIncome = 0;
                    if (year >= otherIncomeYear) simIncome += otherIncomeAmt * Math.pow(1 + inflationRate, i);
                    if (year <= currentIncomeEndYear) simIncome += currentIncomeAmt * Math.pow(1 + inflationRate, i);

                    let net = simIncome - simWithdrawal;
                    let investable = simBal + net;
                    
                    if (investable < 0) investable = 0;

                    let growth = investable * randomReturn;
                    let end = investable + growth;

                    if (end <= 0) {
                        end = 0;
                        if (runFailedStep === Infinity) runFailedStep = i;
                    }

                    yearlyAggregates[i].balances.push(end);
                    yearlyAggregates[i].withdrawals.push(simWithdrawal);
                    yearlyAggregates[i].incomes.push(simIncome);
                    yearlyAggregates[i].growths.push(growth);

                    let nextWithdrawal = simWithdrawal;
                    if (flexibleSpending && randomReturn < 0) nextWithdrawal = simWithdrawal;
                    else nextWithdrawal = simWithdrawal * (1 + inflationRate);

                    simBal = end;
                    simWithdrawal = nextWithdrawal;
                    
                    if (dataPoints[dataPoints.length - 1] > 0) dataPoints.push(simBal);
                }

                if (runFailedStep === Infinity) successes++;
                finalBalances.push(simBal);
                if (runFailedStep < minFailureStep) {
                    minFailureStep = runFailedStep;
                    earliestFailureIndex = s;
                }

                // Color Selection based on Theme
                const isLight = document.documentElement.getAttribute('data-theme') === 'light';
                const lineColor = isLight ? 'rgba(37, 99, 235, 0.1)' : 'rgba(56, 189, 248, 0.1)'; // Blue-600 vs Sky-400

                simulationDatasets.push({
                    label: `Sim ${s}`,
                    data: dataPoints,
                    borderColor: lineColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4,
                    order: 10 
                });
            }
            
            if (earliestFailureIndex !== -1) {
                const failSet = simulationDatasets[earliestFailureIndex];
                failSet.borderColor = 'rgba(244, 63, 94, 0.8)'; // Rose-500
                failSet.borderWidth = 2;
                failSet.label = "Earliest Failure";
                failSet.order = 2; 
            }

            // Stats
            const medianVal = getMedian(finalBalances); 
            finalBalances.sort((a, b) => a - b);
            const p10Val = finalBalances[Math.floor(finalBalances.length * 0.1)];
            const p90Val = finalBalances[Math.floor(finalBalances.length * 0.9)];

            document.getElementById('medianEnd').innerText = formatCurrency(medianVal);
            document.getElementById('successRate').innerText = Math.round((successes / numSimulations) * 100) + "%";
            document.getElementById('p10End').innerText = formatCurrency(p10Val);
            document.getElementById('p90End').innerText = formatCurrency(p90Val);

            // Table Data
            const medianPathData = [];
            const tbody = document.getElementById('projectionBody');
            tbody.innerHTML = '';

            for(let i=0; i<=years; i++) {
                const year = currentYearGlobal + i;
                const ageNow = age + i;
                const agg = yearlyAggregates[i];
                const medianBal = getMedian(agg.balances);
                medianPathData.push(medianBal);

                if(i > 0) {
                    const prevMedianBal = medianPathData[i-1];
                    const medianWithdraw = getMedian(agg.withdrawals);
                    const medianIncome = getMedian(agg.incomes);
                    const medianGrowth = getMedian(agg.growths);
                    const realBal = medianBal / Math.pow(1 + inflationRate, i);

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-muted/50 transition-colors border-b border-border";
                    tr.innerHTML = `
                        <td class="p-4 text-muted-foreground">${year}</td>
                        <td class="p-4 text-muted-foreground">${ageNow}</td>
                        <td class="p-4 text-right font-mono text-foreground">${formatCurrency(prevMedianBal)}</td>
                        <td class="p-4 text-right font-mono text-rose-400/90">-${formatCurrency(medianWithdraw)}</td>
                        <td class="p-4 text-right font-mono text-emerald-400/90">+${formatCurrency(medianIncome)}</td>
                        <td class="p-4 text-right font-mono text-emerald-600/90">${formatCurrency(medianGrowth)}</td>
                        <td class="p-4 text-right font-mono font-bold text-foreground">${formatCurrency(medianBal)}</td>
                        <td class="p-4 text-right font-mono text-purple-400/90">${formatCurrency(realBal)}</td>
                    `;
                    tbody.appendChild(tr);
                } 
            }

            // Chart Colors
            const style = getComputedStyle(document.documentElement); // Changed to documentElement to catch root variables reliably
            const gridColorRaw = style.getPropertyValue('--chart-grid').trim();
            const textColorRaw = style.getPropertyValue('--chart-text').trim();
            
            // Helper to wrap CSS vars in hsl() if they aren't hex
            const getColor = (varName) => {
                const val = style.getPropertyValue(varName).trim();
                // If it looks like HSL channels (has spaces/percentages but no commas/parentheses), wrap it
                if (val && !val.startsWith('#') && !val.startsWith('hsl')) {
                    return `hsl(${val})`;
                }
                return val;
            };

            const gridColor = gridColorRaw.startsWith('#') ? gridColorRaw : getColor('--border'); // Fallback to border if chart-grid fails
            const textColor = textColorRaw.startsWith('#') ? textColorRaw : getColor('--muted-foreground');
            const medianColor = '#fbbf24'; // Amber-400

            const ctx = document.getElementById('fireChart').getContext('2d');
            const labels = [];
            for(let i=0; i<=years; i++) labels.push(currentYearGlobal + i);
            const yMax = Math.max(p90Val, totalPortfolio) * 1.25;

            const avgDataset = {
                label: 'Median Market Path',
                data: medianPathData,
                borderColor: medianColor, 
                borderWidth: 3,
                pointRadius: 0,
                tension: 0.4,
                order: 1 
            };

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [avgDataset, ...simulationDatasets] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            // Use the helper to ensure valid HSL strings
                            backgroundColor: getColor('--popover') || '#18181b',
                            titleColor: getColor('--popover-foreground') || '#f4f4f5',
                            bodyColor: getColor('--muted-foreground') || '#a1a1aa',
                            borderColor: getColor('--border') || '#27272a',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const year = parseInt(tooltipItems[0].label);
                                    const ageAtYear = age + (year - currentYearGlobal);
                                    return `${year} (Age: ${ageAtYear})`;
                                },
                                label: function(context) {
                                    if(context.dataset.label === 'Median Market Path') {
                                        return 'Median: ' + formatCurrency(context.raw);
                                    }
                                    if(context.dataset.label === 'Earliest Failure') {
                                        return 'Early Fail: ' + formatCurrency(context.raw);
                                    }
                                    return ''; 
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yMax,
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                font: { family: 'Inter', size: 10 },
                                callback: function(value, index, values) {
                                    if (index === values.length - 1) return null;
                                    if (value >= 1000000000) return '$' + (value / 1000000000).toFixed(1) + 'B';
                                    if (value >= 1000000) return '$' + (value / 1000000).toFixed(0) + 'M';
                                    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'k';
                                    return '$' + Math.round(value).toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: textColor, font: { family: 'Inter', size: 10 } }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Listeners
        document.getElementById('calcBtn').addEventListener('click', () => {
            baseSeed = Math.floor(Math.random() * 100000);
            calculate();
        });
        
        document.querySelectorAll('.save-input').forEach(input => {
            input.addEventListener('change', () => {
                saveData();
                calculate();
            });
        });
        
        document.getElementById('withdrawalRate').addEventListener('input', calculate);
        document.getElementById('bondReturn').addEventListener('input', calculate);
        document.getElementById('merFee').addEventListener('input', calculate);
        document.getElementById('currentIncome').addEventListener('blur', calculate); 
        document.getElementById('resetBtn').addEventListener('click', resetData);

        const portfolioWrapper = document.querySelector('.lg\\:w-\\[420px\\]'); 
        portfolioWrapper.addEventListener('input', (e) => {
            if(e.target.classList.contains('portfolio-input')) {
                const total = getTotalPortfolio();
                document.getElementById('displayTotalPortfolio').innerText = formatCurrency(total);
                const amount = parseCurrencyInput(document.getElementById('withdrawalAmount').value);
                if (total > 0) {
                    const rate = (amount / total) * 100;
                    document.getElementById('withdrawalRate').value = parseFloat(rate.toFixed(4)); 
                }
            }
        });

        // Initialize
        window.onload = function() {
            const dataLoaded = loadData();
            updateSliderRanges();
            const incomeSlider = document.getElementById('currentIncomeEnd');
            document.getElementById('currentIncomeEndLabel').innerText = incomeSlider.value;
            if (dataLoaded) document.getElementById('otherIncomeStartLabel').innerText = document.getElementById('otherIncomeStart').value;
            if (!dataLoaded) {
                const total = getTotalPortfolio();
                const defaultRate = parseFloat(document.getElementById('withdrawalRate').value) / 100;
                document.getElementById('withdrawalAmount').value = formatCurrency(total * defaultRate);
            }
            calculate();
        };
    </script>
</body>
</html>
